# QuickEdit++ 知识库改造方案

## 项目概述

本文档描述了将QuickEdit++从单文件编辑器改造为支持知识库管理系统的详细方案。

## 当前架构分析

QuickEdit++是一个基于CustomTkinter的文本编辑器，具有以下特点：
1. 模块化架构：代码已分为多个模块（编辑器、文件操作、UI等）
2. 单文件编辑：目前只能同时编辑一个文件
3. 基本的文件操作：新建、打开、保存、另存为等
4. 语法高亮支持
5. 配置管理系统

## 知识库改造方案

### 1. 核心概念设计

**知识库**：一个特殊的目录，包含相关的文档、笔记和资源文件
**知识库管理**：创建、选择、切换不同的知识库
**文件树视图**：显示知识库中的文件和文件夹结构
**多文件支持**：同时打开和编辑多个文件

### 2. 架构改造方案

#### A. 新增模块

1. **知识库管理器** (`app/knowledge_base_manager.py`)
   - 创建、删除、重命名知识库
   - 管理知识库列表
   - 切换当前活动知识库

2. **文件树视图** (`ui/file_tree_view.py`)
   - 显示知识库的文件结构
   - 支持文件的创建、删除、重命名
   - 支持文件夹的展开/折叠
   - 双击文件直接在编辑器中打开（替换当前文件）

3. **知识库对话框** (`ui/knowledge_base_dialog.py`)
   - 创建新知识库的对话框
   - 管理现有知识库的对话框

#### B. 现有模块改造

1. **主编辑器** (`app/editor.py`)
   - 集成文件树视图
   - 调整布局以适应新组件
   - 保持单文件编辑模式不变

2. **文件操作** (`app/file_operations.py`)
   - 增加知识库相关的文件操作
   - 支持在知识库内创建新文件/文件夹
   - 保持现有的单文件操作逻辑

3. **菜单系统** (`ui/menu.py`)
   - 添加知识库相关的菜单项
   - 添加文件树相关的右键菜单
   - 保持现有文件菜单的基本结构

4. **配置管理** (`config/config_manager.py`)
   - 添加知识库相关的配置项
   - 保存最近使用的知识库

5. **应用初始化器** (`app/app_initializer.py`)
   - 初始化知识库管理器
   - 初始化文件树视图

### 3. UI布局改造

```
┌─────────────────────────────────────────────────────────────┐
│ 菜单栏                                                      │
├─────────────────────────────────────────────────────────────┤
│          │                    工具栏                        │
├          ┬──────────────────────────────────────────────────┤
│ [新建KB] │                                                  │
│ [打开KB] │                文件内容编辑区域                  │
│ [切换KB] │                                                  │
├──────────┼                                                  │
│ 文件树   │                                                  │
│          │                                                  │
│ 📁知识库1 │                                                 │
│ 📁笔记   │                                                  │
│ 📄文件1  │                                                  │
│ 📄文件2  │                                                  │
│          │                                                  │
├          ┼──────────────────────────────────────────────────┤
│          │ 状态栏                                           │
└──────────┴──────────────────────────────────────────────────┘
```

在文件树侧边栏中，知识库管理工具栏与文件树并列，位于菜单栏之下，包含以下功能按钮：
- 新建知识库
- 打开知识库
- 切换知识库（下拉选择）

工具栏仅在右侧编辑区域显示，不横跨整个窗口。

### 4. 实现步骤

#### 第一步：创建知识库管理器
- 实现知识库的创建、选择、删除功能
- 添加知识库配置管理
- 在配置文件中存储知识库信息

#### 第二步：实现文件树视图
- 创建文件树UI组件
- 实现文件/文件夹的基本操作
- 添加右键菜单支持

#### 第三步：集成文件树与编辑器
- 实现文件树与编辑器的交互
- 处理文件双击打开逻辑
- 实现知识库与文件树的联动

#### 第四步：集成所有组件
- 调整主窗口布局
- 连接各组件的交互逻辑
- 实现知识库与文件树的联动

#### 第五步：完善功能
- 添加搜索功能
- 实现文件间的快速跳转
- 添加模板功能
- 实现知识库导入/导出

### 5. 技术考虑

#### A. 数据存储
- 知识库信息存储在配置文件中
- 每个知识库对应一个实际的文件系统目录
- 使用JSON格式存储知识库元数据

#### B. 性能优化
- 大型知识库的延迟加载
- 文件树的虚拟化（如果需要）
- 文件内容的按需加载

#### C. 用户体验
- 保存每个知识库的打开文件状态
- 支持文件的全局搜索
- 快捷键支持
- 拖拽操作支持

### 6. 配置扩展

在现有配置基础上，添加以下配置项：

```json
{
  "knowledge_base": {
    "default_location": "", // 默认知识库存储位置
    "current_kb": "", // 当前活动知识库
    "kb_list": [] // 知识库列表（按最近使用顺序排列）
  },
  "file_tree": {
    "show_hidden_files": false, // 是否显示隐藏文件
    "expand_level": 1 // 默认只展开一层
  }
}
```

### 7. 类设计概览

#### A. KnowledgeBaseManager
```python
class KnowledgeBaseManager:
    def __init__(self, config_manager)
    def create_knowledge_base(self, name, path)
    def delete_knowledge_base(self, kb_id)
    def get_knowledge_base_list(self)
    def set_current_knowledge_base(self, kb_id)
    def get_current_knowledge_base(self)
    def save_knowledge_base_state(self, state)
    def load_knowledge_base_state(self)
```

#### C. FileTreeView
```python
class FileTreeView(ctk.CTkFrame):
    def __init__(self, parent, knowledge_base_manager, file_operations)
    def refresh_tree(self, path)
    def create_file(self, parent_path, filename)
    def create_folder(self, parent_path, foldername)
    def delete_item(self, item_path)
    def rename_item(self, item_path, new_name)
    def on_item_double_click(self, item_path)  # 打开文件，替换当前编辑器内容
    def show_context_menu(self, event)
    def highlight_current_file(self, file_path)  # 高亮当前打开的文件
```

#### D. KnowledgeBaseToolbar
```python
class KnowledgeBaseToolbar(ctk.CTkFrame):
    def __init__(self, parent, knowledge_base_manager)
    def create_new_kb_button(self)  # 创建新建知识库按钮
    def create_open_kb_button(self)  # 创建打开知识库按钮
    def create_kb_selector(self)  # 创建知识库选择下拉框
    def update_kb_list(self)  # 更新知识库列表
    def on_kb_selected(self, kb_id)  # 处理知识库选择事件
```

### 8. 菜单扩展

在文件树侧边栏中添加知识库管理工具栏，与文件树并列，包含以下功能按钮：

#### 知识库工具栏
- **新建知识库按钮**：创建新的知识库
- **打开知识库按钮**：打开现有的知识库目录
- **知识库选择下拉框**：显示当前知识库并允许切换到其他知识库

**注意**：工具栏按钮位于左侧文件树区域，与文件树并列，而不是在右侧编辑区域。

#### 文件菜单（可选扩展）
- 新建知识库
- 打开知识库
- 关闭知识库
- 知识库设置

#### 编辑菜单（可选扩展）
- 在知识库中搜索
- 在当前文件夹中搜索

#### 视图菜单（可选扩展）
- 显示/隐藏文件树
- 文件树设置

### 9. 快捷键扩展

添加以下快捷键（可选）：
- Ctrl+Shift+K: 创建新知识库
- Ctrl+Shift+O: 打开知识库
- Ctrl+Shift+W: 关闭知识库
- Ctrl+Shift+F: 在知识库中搜索
- Ctrl+N: 在当前知识库中新建文件
- Ctrl+Shift+N: 在当前知识库中新建文件夹

**注意**：主要操作通过文件树顶部的工具栏按钮完成，快捷键作为辅助功能。

### 10. 实现优先级

1. **高优先级**：
   - 知识库管理器
   - 文件树视图
   - 文件树与编辑器的交互

2. **中优先级**：
   - 搜索功能
   - 模板功能
   - 快捷键支持

3. **低优先级**：
   - 高级搜索
   - 知识库导入/导出
   - 主题定制

### 11. 测试计划

1. **单元测试**：
   - 知识库管理器功能测试
   - 文件树视图功能测试
   - 文件树与编辑器交互测试

2. **集成测试**：
   - 组件间交互测试
   - 配置管理测试
   - 文件操作测试

3. **用户测试**：
   - 界面易用性测试
   - 性能测试
   - 兼容性测试

## 总结

这个改造方案将QuickEdit++从单文件编辑器转变为支持知识库管理的编辑器，同时保留原有的单文件编辑功能和性能优势。通过添加文件树视图和知识库管理功能，用户可以更方便地组织和管理文件，而无需改变单文件编辑的核心体验。

主要改动包括：
1. 添加知识库管理功能
2. 添加文件树视图，支持浏览和快速打开文件
3. 保持单文件编辑模式，每次只打开一个文件
4. 最小化对现有代码的改动，保持向后兼容

通过模块化设计和分阶段实现，可以确保改造过程的可控性和稳定性。

改造完成后，用户将能够：
1. 创建和管理多个知识库
2. 在知识库中组织文件和文件夹
3. 通过文件树快速浏览和打开文件（一次只打开一个文件）
4. 快速搜索和导航文件
5. 保存和恢复工作状态

这将大大提升QuickEdit++的实用性和用户体验，同时保持其简洁的单文件编辑模式。